input:
  root: GlobalParams
  objects:
    GlobalParams:
      properties:
        platform: 
          type:
            type_id: enum
        kubeconfig: 
          type:
            type_id: str
        es_server: 
          type:
            type_id: str
        metadata_collection: 
          type:
            type_id: bool
        metadata_targeted: 
          type:
            type_id: bool
        system_metrics_collection: 
          type:
            type_id: bool
        uuid: 
          type:
            type_id: str
        cluster_name: 
          type:
            type_id: str
        prom_token: 
          type:
            type_id: str
    PlatformParams:
      #TODO
    SUTParams:
      properties:
        network_policy: 
          type:
            type_id: bool
        multi_az: 
          type:
            type_id: bool
        hostnetwork: 
          type:
            type_id: bool
        serviceip: 
          type:
            type_id: bool
        test_timeout: 
          type:
            type_id: int
        run_id: 
          type:
            type_id: str
        servicetype: 
          type:
            type_id: str
        metallb:
          addresspool: 
            type:
              type_id: str
            service_etp: 
            type:
              type_id: str
        multus:
          enabled: 
            type:
              type_id: bool
    WorkloadGeometry:
      #TODO
      samples: int
      pairs: list[int]
    UperfWorkloadDefaults:
      objects:
        ProfileGroup:
          properties:
            transactions: list
            nthreads: list[int] #FIXME -- input schema is a single int
        ProfileTransaction:
          properties:
            flowops: list
            #Note: duration is "runtime" in the benchmark-operator CR
            duration: string #FIXME -- is a string in the schema; should it be an int?
        ConnectFlowOp:
          properties:
            protocol: list[enum] #FIXME -- input schema is a single enum_string
        test_types:  list[enum] #FIXME -- these are pseudonyms for flowop combinations
        sizes:  list[int] #FIXME -- this is a per-flowop param and they are single items per flowop
    UperfWorkloads: list #TODO -- how do we accept a list of workloads with overrides for the above defaults?


output: ${steps.run_uperf_client.output["success"]}


steps:
  read_kubeconfig:
    plugin: quay.io/arcalot/read-kubeconfig-plugin:latest
  kube_host_lookup:
    plugin: quay.io/arcalot/kubernetes-host-lookup-plugin:latest
    input:
      credentials: ${steps.read_kubeconfig.output["success"].credentials}
      namespace: default
  run_uperf:server:
    operator: parallel_foreach
    for_each: ${steps.kube_host_lookup.output["success"].host}
    steps:
      uperf_server:
        plugin: quay.io/arcalot/uperf-plugin:latest
        step: server
        deploy:
          node: ${steps.run_uperf_server.current_item}
  run_uperf_client:
    needs:
      - steps.run_uperf_server.output["success"]
    operator: parallel_foreach
    for_each: ${steps.host_lookup.output["success"].host}
    steps:
      uperf_client:
        plugin: quay.io/arcalot/uperf:latest
        step: client
        deploy:
          node: ${steps.run_uperf_client.current_item}
        input:
          target: ${select_random{steps.host_lookup.output["success"].host}}



